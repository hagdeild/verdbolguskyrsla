---
title: "Verðbólgugreining"
format:
    dashboard:
        theme: flatly
        scrolling: false
        css: styles.css
---

```{r, pakkar}
library(tidyverse)
library(scales)
library(plotly)

```

```{r, data og annað}
data_ls <- read_rds("data/final_data.rds")
fc_ls   <- read_rds("data/spar.rds")

# Litir
vr_litir <- c("#00305c", "#028fbc", "#eec215", "#d64550", "#4fb94f", "#7d5ba6", "#e07b39", "#3a8e8e")
valuebox_litir <- c("#2E7D6E", "#E57373", "#F9A825")

# Date
date_back_year <- floor_date(today(), "year") - months(12)
```

```{r, hjalparfoll}

# VR plot layout
vr_layout <- function(plot) {
  plotly::ggplotly(plot) |>
    plotly::layout(
      legend = list(
        title = list(text = ""),
        orientation = "h",
        y = -0.2,
        x = 0.5,
        xanchor = "center"
      )
    )
}


# Waterfall plot function
waterfall_plot <- function(
  data,
  value_col,                      
  category_col = undirflokkur,    
  title = "Framlag undirliða seinustu 12 mánuði",
  total_bar_title = "Verðbólga",
  color_pos = vr_litir[4],
  color_neg = vr_litir[5],
  color_total = vr_litir[1],
  label_digits = 1,
  bar_width = 0.6,
  pad_frac = 0.02,
  base_size = 12,
  flip = FALSE                    
) {
  df <- data %>%
    transmute(
      category = {{ category_col }},
      value    = {{ value_col }}
    ) %>%
    mutate(sign_grp = case_when(value > 0 ~ 2L,
                                value == 0 ~ 1L,
                                TRUE ~ 0L)) %>%
    arrange(desc(sign_grp), desc(value)) %>%
    select(-sign_grp)

  n_pos <- sum(df$value > 0, na.rm = TRUE)
  n_neg <- sum(df$value <= 0, na.rm = TRUE)
  waterfall_colors <- c(rep(color_pos, n_pos), rep(color_neg, n_neg))

  steps <- df %>%
    mutate(
      step  = row_number(),
      start = lag(cumsum(value), default = 0),
      end   = start + value,
      ymin  = pmin(start, end),
      ymax  = pmax(start, end),
      type  = "change",
      label = sprintf(paste0("%.", label_digits, "f%%"), value * 100)
    )

  total_val <- sum(df$value, na.rm = TRUE)
  total_row <- tibble(
    category = total_bar_title,
    value    = total_val,
    step     = nrow(df) + 1,
    start    = 0,
    end      = total_val,
    ymin     = pmin(0, total_val),
    ymax     = pmax(0, total_val),
    type     = "total",
    label    = sprintf(paste0("%.", label_digits, "f%%"), total_val * 100)
  )

  plot_df <- bind_rows(steps, total_row)

  yrange <- max(plot_df$ymax, 0) - min(plot_df$ymin, 0)
  pad <- pad_frac * yrange

  plot_df <- plot_df %>%
    mutate(
      y_lab     = if_else(value >= 0, ymax + pad, ymin - pad),
      vjust_lab = if_else(value >= 0, 0, 1)
    )

  stopifnot(length(waterfall_colors) == nrow(df))
  fill_vec <- c(waterfall_colors, color_total)
  half_w <- bar_width / 2

  p <- ggplot(plot_df) +
    geom_rect(
      aes(xmin = step - half_w, xmax = step + half_w,
          ymin = ymin, ymax = ymax,
          fill = factor(step)),
      color = NA
    ) +
    geom_hline(yintercept = 0, color = "black", linewidth = 0.4) +  # <-- zero line
    geom_text(aes(x = step, y = y_lab, label = label), size = 3.5) +
    scale_fill_manual(values = fill_vec, guide = "none") +
    scale_y_continuous(expand = expansion(mult = c(0.02, 0.08))) +
    labs(x = NULL, y = NULL, title = title) +
    theme_minimal(base_size = base_size) +
    theme(
      plot.margin = margin(8, 8, 8, 8)
    ) +
    coord_cartesian(clip = "off")

  if (flip) {
    p <- p +
      scale_x_continuous(
        breaks = plot_df$step,
        labels = plot_df$category,
        expand = c(0.01, 0),
        trans = "reverse"
      ) +
      coord_flip() +
      theme(
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 9)
      )
  } else {
    p <- p +
      scale_x_continuous(
        breaks = plot_df$step,
        labels = plot_df$category,
        expand = c(0.01, 0)
      ) +
      theme(
        axis.text.y = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, size = 9)  
      )
  }

  p
}


```

# Verðbólga

## Row

```{r, valuebox_data_prep}
inflation_diff  <- data_ls$pbi_inflation_verdbolga |> 
    filter(flokkur == "Verðbólga") |> 
    mutate(diff = verdbolga - lag(verdbolga)) |> 
    tail(1) |> 
    pull(diff)

verdbolga_latest <- data_ls$pbi_inflation_verdbolga_valuebox |> 
    pull(verdbolga) |> 
    percent(accuracy = 0.1)

verdbolga_milli_manada_latest <- data_ls$pbi_inflation_verdbolga_valuebox |> 
    pull(milli_manada) |> 
    percent(accuracy = 0.01)

verdbolga_hradi <- data_ls$pbi_inflation_verdbolga_valuebox |> 
    pull(hradi) |> 
    percent(accuracy = 0.1)

verdbolga_hradi_diff <- data_ls$pbi_inflation_verdbolga_valuebox$hradi_diff

```

```{r, valueboxe-inflation}
#| content: valuebox
#| title: "Verðbólga"
list(
    icon = case_when(
        inflation_diff < 0 ~ "arrow-down",
        inflation_diff > 0 ~ "arrow-up",
        TRUE ~ "dash"
        ),
    color = 
        case_when(
        inflation_diff < 0 ~ valuebox_litir[1],
        inflation_diff > 0 ~ valuebox_litir[2],
        TRUE ~ valuebox_litir[3]
        ),
    value = verdbolga_latest
)
```

```{r, valuebox_inflation_mom}
#| content: valuebox
#| title: "Verðbólga milli mánaða"
list(
    icon = case_when(
        verdbolga_milli_manada_latest < 0 ~ "arrow-down",
        verdbolga_milli_manada_latest > 0 ~ "arrow-up",
        TRUE ~ "dash"
        ),
    color = 
        case_when(
        verdbolga_milli_manada_latest < 0 ~ valuebox_litir[1],
        verdbolga_milli_manada_latest > 0 ~ valuebox_litir[2],
        TRUE ~ valuebox_litir[3]
        ),
    value = verdbolga_milli_manada_latest
)
```

```{r, valuebox_12m_taktur}
#| content: valuebox
#| title: "Tólf mánaða verðbólga m.v. seinustu sex mánuði"
list(
    icon = case_when(
        verdbolga_hradi_diff < 0 ~ "arrow-down",
        verdbolga_hradi_diff > 0 ~ "arrow-up",
        TRUE ~ "dash"
        ),
    color = 
        case_when(
        verdbolga_hradi_diff < 0 ~ valuebox_litir[1],
        verdbolga_hradi_diff > 0 ~ valuebox_litir[2],
        TRUE ~ valuebox_litir[3]
        ),
    value = verdbolga_hradi
)
```

## Row

```{r, verðbólga-plot}
p1 <- data_ls$pbi_inflation_verdbolga |> 
    ggplot(aes(date, verdbolga, col = flokkur)) + 
    geom_line() + 
    labs(
        x = NULL,
        y = NULL,
        title = "Verðbólga"
    ) +
    theme_minimal() +
    scale_color_manual(values = vr_litir) +
    scale_y_continuous(labels = percent)
    
vr_layout(p1)
```

```{r, verðbólga-mom}
p2 <- data_ls$pbi_inflation_verdbolga |> 
    filter(
        flokkur == "Verðbólga",
        date >= date_back_year
        ) |> 
    ggplot(aes(date, milli_manada)) + 
    geom_col(fill = vr_litir[1]) + 
    labs(
        x = NULL,
        y = NULL,
        title = "Verðbólga milli mánaða"
    ) +
    theme_minimal() +
    scale_y_continuous(labels = percent)
    
ggplotly(p2) 
```

# Undirliggjandi verðbólga

## Row

```{r, undirliggjandi-verðbólga}
p3 <- data_ls$pbi_inflation_undirliggjandi |> 
    ungroup() |> 
    filter(!name == "Kjarnavísitala 3") |> 
    ggplot(aes(date, value, col = name)) + 
    geom_line() +
    labs(
        x = NULL,
        y = NULL,
        title = "Undirliggjandi verðbólga"
    ) +
    theme_minimal() +
    scale_color_manual(values = vr_litir) +
    scale_y_continuous(labels = percent)

vr_layout(p3)
```

```{r, verðbólga eftir uppruna}
p4 <- data_ls$pbi_inflation_uppruni |> 
    ggplot(aes(date, delta, col = flokkur)) + 
    geom_line() +
    labs(
        x = NULL,
        y = NULL,
        title = "Verðbólga eftir uppruna"
    ) +
    theme_minimal() +
    scale_color_manual(values = vr_litir) +
    scale_y_continuous(labels = percent)

vr_layout(p4)
```

## Row

::: callout-note
## Liðir undirliggjandi verðbólgu

-   **Kjarna­vísitala 1**: VNV án búvöru, grænmetis, ávaxta og bensíns\
-   **Kjarna­vísitala 2**: Kjarna­vísitala 1 án opinberrar þjónustu\
-   **Kjarna­vísitala 3**: Kjarna­vísitala 2 án áhrifa vaxtabreytinga á húsnæðisliði *(ekki reiknuð lengur)*\
-   **Kjarna­vísitala 4**: Kjarna­vísitala 2 án reiknaðrar húsaleigu
:::

```{r, froop}
p5 <- data_ls$pbi_inflation_froop |> 
    select(date, froop, non_froop, verdbolga) |> 
    set_names("date", "Keypt oft", "Keypt sjaldan", "Verbólga") |> 
    pivot_longer(cols = -date) |> 
    ggplot(aes(date, value, col = name)) + 
    geom_line() + 
    labs(
        x = NULL,
        y = NULL,
        title = "Verðbólga eftir því hvort vara er keypt oft eða ekki"
    ) +
    theme_minimal() +
    scale_color_manual(values = vr_litir) +
    scale_y_continuous(labels = percent)

vr_layout(p5)
```

# Framlag undirliða 12m

```{r waterfall_12m, fig.width = 16, fig.height = 8}

waterfall_plot(
  data_ls$pbi_inflation_waterfall,
  ahrif,
  title = "Framlag undirliða seinustu 12 mánuði",
  flip = TRUE
)

```

# Framlag undirliða 1m

```{r, waterfal_1m, fig.width = 16, fig.height = 8}
waterfall_plot(
  data_ls$pbi_inflation_waterfall,
  ahrif_1m,
  title = "Framlag undirliða seinustu 12 mánuði",
  flip = TRUE
)

```

# Undirflokkar 12m

```{r, undirflokkar_12m, fig.width = 16, fig.height = 8}
data_ls$phi_inflation_undirflokkar |> 
    mutate(
        merking = percent(value, accuracy = 0.1),
        merking_pos = if_else(value >= 0, value + 0.0075, value -0.0075)
        ) |> 
    ggplot(aes(fct_reorder(name, -value),  value)) + 
    geom_col(fill = vr_litir[1]) + 
    geom_hline(aes(yintercept = verdbolga), col = vr_litir[2]) +
    geom_text(aes(y = merking_pos, label = merking)) + 
    labs(
        x = NULL,
        y = NULL,
        title = "12 mánaða verðbólga undirliða"
    ) +
    theme_minimal() +
    coord_cartesian(clip = "off") +
    coord_flip() +
    scale_y_continuous(label = percent)

```

# Undirflokkar 1m

```{r, undirflokkar_1m, fig.width = 16, fig.height = 8}
data_ls$phi_inflation_undirflokkar_1m |>
  mutate(
    merking = percent(value, accuracy = 0.1),
    merking_pos = if_else(value >= 0, value + 0.0075, value -0.0075)
    ) |>
  ggplot(aes(fct_reorder(name, -value), value)) +
  geom_col(fill = vr_litir[1]) +
  geom_hline(aes(yintercept = verdbolga), col = vr_litir[2]) +
  geom_text(aes(y = merking_pos, label = merking)) + 
  labs(x = NULL, y = NULL, title = "1 mánaða verðbólga undirliða") +
  theme_minimal() +
  coord_cartesian(clip = "off") +
  coord_flip() +
  scale_y_continuous(label = percent)

```

# Top 10 listinn

## Row
```{r top10_12m}
p_top10_12m <- data_ls$top_12m |> 
    mutate(
        merking = percent(infl_12m, accuracy = 0.10),
        merking_pos = if_else(infl_12m >= 0, infl_12m + 0.01, infl_12m - 0.01)
    ) |> 
    ggplot(aes(fct_reorder(flokkur, infl_12m), infl_12m)) +
    geom_col(fill = vr_litir[1]) +
    geom_text(aes(label = merking, y = merking_pos)) + 
    theme_minimal() + 
    labs(
        x = NULL,
        y = NULL,
        title = "Top 10 mestu hækkanir seinustu 12 mánuði"
    ) + 
    scale_y_continuous(labels = percent) + 
    coord_flip()

vr_layout(p_top10_12m)

```


```{r, bottom10_12m}
p_botn_12m <- data_ls$botn_12m |> 
    mutate(
        merking = percent(infl_12m, accuracy = 0.10),
        merking_pos = if_else(infl_12m >= 0, infl_12m + 0.01, infl_12m - 0.01)
    ) |> 
    ggplot(aes(fct_reorder(flokkur, infl_12m), infl_12m)) +
    geom_col(fill = vr_litir[1]) +
    geom_text(aes(label = merking, y = merking_pos)) + 
    theme_minimal() + 
    labs(
        x = NULL,
        y = NULL,
        title = "Top 10 minnstu hækkanir seinustu 12 mánuði"
    ) + 
    scale_y_continuous(labels = percent) + 
    coord_flip()

vr_layout(p_botn_12m)
```


## Row

```{r, top10_1m}
p_top10_1m <- data_ls$top_1m |> 
    mutate(
        merking = percent(infl_1m, accuracy = 0.10),
        merking_pos = if_else(infl_1m >= 0, infl_1m + 0.01, infl_1m - 0.01)
    ) |> 
    ggplot(aes(fct_reorder(flokkur, infl_1m), infl_1m)) +
    geom_col(fill = vr_litir[1]) +
    geom_text(aes(label = merking, y = merking_pos)) + 
    theme_minimal() + 
    labs(
        x = NULL,
        y = NULL,
        title = "Top 10 mestu hækkanir milli mánaða"
    ) + 
    scale_y_continuous(labels = percent) + 
    coord_flip()

vr_layout(p_top10_1m)

```

```{r, botn10_1m}
p_botn_1m <- data_ls$botn_1m |> 
    mutate(
        merking = percent(infl_1m, accuracy = 0.10),
        merking_pos = if_else(infl_1m >= 0, infl_1m + 0.01, infl_1m - 0.01)
    ) |> 
    ggplot(aes(fct_reorder(flokkur, infl_1m), infl_1m)) +
    geom_col(fill = vr_litir[1]) +
    geom_text(aes(label = merking, y = merking_pos)) + 
    theme_minimal() + 
    labs(
        x = NULL,
        y = NULL,
        title = "Top 10 minnstu hækkanir milli mánaða"
    ) + 
    scale_y_continuous(labels = percent) + 
    coord_flip()

vr_layout(p_botn_1m)
```


# Samræmd vísitala

## Row

```{r, samræmd data prep}
hicp_diff_tbl <- data_ls$pbi_inflation_hicp |> 
    filter(flokkur == "CP00") |> 
    arrange(date, country) |> 
    group_by(country) |> 
    mutate(infl_diff = infl - lag(infl)) |> 
    filter(date == max(date, na.rm = TRUE)) |> 
    select(country, infl_diff)

hicp_infl_tbl <- data_ls$pbi_inflation_hicp |> 
    filter(date == max(date)) |> 
    select(country, infl) |> 
    mutate(infl = percent(infl, accuracy = 0.1))

get_country_diff <- function(land) {
    hicp_diff_tbl |> 
    filter(country == land) |> 
    pull(infl_diff)
}

get_country_hicp <- function(land) {
    hicp_infl_tbl |> 
    filter(country == land) |> 
    pull(infl)
}

# Ísland
hicp_island_diff <- get_country_diff("Ísland")
hicp_island_infl <- get_country_hicp("Ísland")

# Danmörk
hicp_dk_diff <- get_country_diff("Danmörk")
hicp_dk_infl <- get_country_hicp("Danmörk")

# Noregur
hicp_no_diff <- get_country_diff("Noregur")
hicp_no_infl <- get_country_hicp("Noregur")

# Finnland
hicp_fi_diff <- get_country_diff("Finnland")
hicp_fi_infl <- get_country_hicp("Finnland")

# Svíþjóð
hicp_se_diff <- get_country_diff("Svíþjóð")
hicp_se_infl <- get_country_hicp("Svíþjóð")

# Evrópa
hicp_eu_diff <- get_country_diff("EU")
hicp_eu_infl <- get_country_hicp("EU")

```

```{r, hicp_island}
#| content: valuebox
#| title: "Ísland"
list(
    icon = case_when(
        hicp_island_diff < 0 ~ "arrow-down",
        hicp_island_diff > 0 ~ "arrow-up",
        TRUE ~ "dash"
        ),
    color = 
        case_when(
        hicp_island_diff < 0 ~ valuebox_litir[1],
        hicp_island_diff > 0 ~ valuebox_litir[2],
        TRUE ~ valuebox_litir[3]
        ),
    value = hicp_island_infl
)

```

```{r, hicp_dk}
#| content: valuebox
#| title: "Danmörk"
list(
    icon = case_when(
        hicp_dk_diff < 0 ~ "arrow-down",
        hicp_dk_diff > 0 ~ "arrow-up",
        TRUE ~ "dash"
        ),
    color = 
        case_when(
        hicp_dk_diff < 0 ~ valuebox_litir[1],
        hicp_dk_diff > 0 ~ valuebox_litir[2],
        TRUE ~ valuebox_litir[3]
        ),
    value = hicp_dk_infl
)
```

```{r, hicp_noregur}
#| content: valuebox
#| title: "Noregur"
list(
    icon = case_when(
        hicp_no_diff < 0 ~ "arrow-down",
        hicp_no_diff > 0 ~ "arrow-up",
        TRUE ~ "dash"
        ),
    color = 
        case_when(
        hicp_no_diff < 0 ~ valuebox_litir[1],
        hicp_no_diff > 0 ~ valuebox_litir[2],
        TRUE ~ valuebox_litir[3]
        ),
    value = hicp_no_infl
)
```

```{r, hicp_svíþjóð}
#| content: valuebox
#| title: "Svíþjóð"
list(
    icon = case_when(
        hicp_se_diff < 0 ~ "arrow-down",
        hicp_se_diff > 0 ~ "arrow-up",
        TRUE ~ "dash"
        ),
    color = 
        case_when(
        hicp_se_diff < 0 ~ valuebox_litir[1],
        hicp_se_diff > 0 ~ valuebox_litir[2],
        TRUE ~ valuebox_litir[3]
        ),
    value = hicp_se_infl
)
```

```{r, hicp_finnland}
#| content: valuebox
#| title: "Finnland"
list(
    icon = case_when(
        hicp_fi_diff < 0 ~ "arrow-down",
        hicp_fi_diff > 0 ~ "arrow-up",
        TRUE ~ "dash"
        ),
    color = 
        case_when(
        hicp_fi_diff < 0 ~ valuebox_litir[1],
        hicp_fi_diff > 0 ~ valuebox_litir[2],
        TRUE ~ valuebox_litir[3]
        ),
    value = hicp_fi_infl
)
```

```{r, hicp_EU}
#| content: valuebox
#| title: "Evrusvæðið"
list(
    icon = case_when(
        hicp_eu_diff < 0 ~ "arrow-down",
        hicp_eu_diff > 0 ~ "arrow-up",
        TRUE ~ "dash"
        ),
    color = 
        case_when(
        hicp_eu_diff < 0 ~ valuebox_litir[1],
        hicp_eu_diff > 0 ~ valuebox_litir[2],
        TRUE ~ valuebox_litir[3]
        ),
    value = hicp_eu_infl
)
```

## Row

```{r, hicp_12m}
p6 <- data_ls$pbi_inflation_hicp |> 
    ggplot(aes(date, infl, col = country)) + 
    geom_line() +
    theme_minimal() +
    scale_y_continuous(labels = percent) +
    scale_color_manual(values = vr_litir) +
    labs(
        x = NULL,
        y = NULL,
        title = "12 mánaða verðbólga"
    )

vr_layout(p6)
```

```{r, hicp_3m}
date_from_3m_hicp <- floor_date(today(), "month") - years(2)

p7 <- data_ls$pbi_inflation_hicp |> 
    filter(date >= date_from_3m_hicp) |> 
    ggplot(aes(date, infl_3m, col = country)) + 
    geom_line() +
    theme_minimal() +
    scale_y_continuous(labels = percent) +
    scale_color_manual(values = vr_litir) +
    labs(
        x = NULL,
        y = NULL,
        title = "3ja mánaða verðbólga"
    )

vr_layout(p7)
```

# Samræmd vísitala - Undirflokkar

## Row

```{r, hicp_undirflokkar_12m}
p8 <- data_ls$pbi_inflation_hicp_undirflokkar |> 
    mutate(
        key = if_else(country == "Ísland", "isl", "other"),
        merking = percent(infl, accuracy = 0.1)
        ) |> 
    ggplot(aes(country, infl, fill = key, label = merking)) + 
    geom_col() + 
    facet_wrap(~ flokkur, nrow = 1) + 
    coord_flip() +
    geom_text(position = position_nudge(y = 0.005)) + 
    scale_fill_manual(values = vr_litir) +
    theme_minimal() +
    labs(
        x = NULL,
        y = NULL,
        title = "Undirflokkar - 12 mánaða verðbólga"
    ) +
    scale_y_continuous(labels = percent)

vr_layout(p8)
```

## Row

```{r, hicp_undirflokkar_3m}
p9 <- data_ls$pbi_inflation_hicp_undirflokkar |> 
    mutate(
        key = if_else(country == "Ísland", "isl", "other"),
        merking = percent(infl_3m, accuracy = 0.1)
        ) |> 
    ggplot(aes(country, infl_3m, fill = key, label = merking)) + 
    geom_col() + 
    facet_wrap(~ flokkur, nrow = 1) + 
    coord_flip() +
    geom_text(position = position_nudge(y = 0.005)) + 
    scale_fill_manual(values = vr_litir) +
    theme_minimal() +
    labs(
        x = NULL,
        y = NULL,
        title = "Undirflokkar - 3ja mánaða verðbólga"
    ) +
    scale_y_continuous(labels = percent)

vr_layout(p9)
```

# Húsnæðismarkaðurinn

## Row

```{r, husnaedis_lidur_vnv}
p10 <- data_ls$pbi_inflation_husnaedisverd |> 
    ggplot(aes(date, infl, col = lidur)) +
    geom_line() +
    theme_minimal() +
    labs(
        x = NULL,
        y = NULL,
        title = "Húsnæði, hitit og rafmagn"
    ) +
    scale_color_manual(values = vr_litir) +
    scale_y_continuous(labels = percent)

vr_layout(p10)
```

```{r, vextir_fasteignalana}
p11 <- data_ls$pbi_inflation_husnaaedisvextir |> 
    pivot_longer(cols = -date) |> 
    ggplot(aes(date, value, col = name)) + 
    geom_line() + 
    theme_minimal() + 
    labs(
        x = NULL,
        y = NULL,
        title = "Vextir fasteignalána og stýrivexti"
    ) +
    scale_y_continuous(labels = percent) + 
    scale_color_manual(values = vr_litir)

vr_layout(p11)
```

## Row

```{r, ny_utlan}
p12 <- data_ls$pbi_inflation_utlan_ny |> 
    ggplot(aes(date, value, fill = name)) + 
    geom_col() +
    scale_fill_manual(values = vr_litir) +
    labs(
        x = NULL,
        y = NULL,
        title = "Ný útlán lífeyrissjóða og innlánsstofnana"
    ) +
    theme_minimal()

vr_layout(p12)
```

```{r, útlánastabbi}
p13 <- data_ls$pbi_inflation_utlanastabbi |> 
    ggplot(aes(date, share, fill = name)) + 
    geom_area() +
    geom_hline(yintercept = 0.5, linetype = "dashed") + 
    labs(
        x = NULL,
        y = NULL,
        title = "Staða útlána"
    ) +
    scale_y_continuous(labels = percent) + 
    scale_fill_manual(values = vr_litir) +
    theme_minimal()

vr_layout(p13)
```

# Væntingar og gjaldeyrismarkaður

## Row

```{r, verðbólguvæntingar}
p14 <- data_ls$pbi_inflation_vaentingar |> 
    ggplot(aes(date, value, col = key)) + 
    geom_line() + 
    labs(
        x = NULL,
        y = NULL,
        title = "Verðbólguvæntingar"
    ) +
    scale_y_continuous(labels = percent) + 
    scale_color_manual(values = vr_litir) + 
    theme_minimal()

vr_layout(p14)
```

```{r, verðbólguvæntingar_skuldabréf}
p15 <- data_ls$pbi_inflation_vaentingar_skuldabrefamarkadur |> 
    ggplot(aes(date, value, col = key)) + 
    geom_line() +
    labs(
        x = NULL,
        y = NULL,
        title = "Verðbólguálaga á skuldabréfamarkaði"
    ) +
    scale_y_continuous(labels = percent) + 
    scale_color_manual(values = vr_litir) + 
    theme_minimal()

vr_layout(p15)
```

## Row

```{r, gjaldmiðlar}
p16 <- data_ls$pbi_inflation_gengi |> 
    ungroup() |> 
    ggplot(aes(date, value, col = name)) +
    geom_line() +
    labs(
        x = NULL,
        y = NULL,
        title = "Gengi gjaldmiðla"
    ) +
    scale_y_continuous(labels = percent) + 
    scale_color_manual(values = vr_litir) + 
    theme_minimal()

vr_layout(p16)
```

```{r, inngrip_si}
inngrip_use_tbl <- data_ls$pbi_inflation_inngrip |> 
    select(date, kaup_hlutfall_velta, EURISK) |> 
    set_names("date", "inngrip", "gengi")

p17_a <- inngrip_use_tbl |> 
    ggplot(aes(date, gengi)) + 
    geom_line() +
    labs(
        x = NULL,
        y = NULL
        #title = "Gengi Evru"
    ) +
    scale_color_manual(values = vr_litir) + 
    theme_minimal()

p17_b <- inngrip_use_tbl |> 
    ggplot(aes(date, inngrip)) + 
    geom_line() + 
    labs(
        x = NULL,
        y = NULL
        #title = "Kaup seðlabankans á gjaldeyrismarkaði, hlutfall af heildarveltu"
    ) +
    scale_y_continuous(labels = percent) + 
    scale_color_manual(values = vr_litir) + 
    theme_minimal()
    
p17_a_plotly <- ggplotly(p17_a)
p17_b_plotly <- ggplotly(p17_b)

p17_plotly <- subplot(
  p17_a_plotly,
  p17_b_plotly,
  nrows = 2,
  shareX = TRUE,
  titleX = TRUE,
  titleY = TRUE
)

p17_plotly |>
  layout(
    # add subplot-specific titles
    annotations = list(
      list(
        text = "Gengi Evru",
        x = 0.5, y = 1, xref = "paper", yref = "paper",
        xanchor = "center", yanchor = "bottom",
        showarrow = FALSE, font = list(size = 14)
      ),
      list(
        text = "Kaup seðlabankans á gjaldeyrismarkaði, hlutfall af heildarveltu",
        x = 0.5, y = 0.47, xref = "paper", yref = "paper",
        xanchor = "center", yanchor = "bottom",
        showarrow = FALSE, font = list(size = 14)
      ),
      # GLOBAL title
      list(
        text = "Inngrip og gengisþróun",
        x = 0.1, y = 1.12, xref = "paper", yref = "paper",
        xanchor = "center", yanchor = "bottom",
        showarrow = FALSE, font = list(size = 18, family = "Arial")
      )
    ),
    legend = list(
      title = list(text = ""),
      orientation = "h",
      y = -0.2,
      x = 0.5,
      xanchor = "center"
    ),
    margin = list(t = 100) # make room for the global title
  )
```

# Verðbólguspá

## Row

```{r, verðbólguspá_valuebox_prep}
# 12 mánaða spá
fc_diff <- fc_ls$verdbolguspa |> 
    filter(name %in% c("Söguleg", "Skammtíma")) |> 
    arrange(date, name) |> 
    mutate(diff = value - lag(value)) |> 
    drop_na() |>
    filter(name == "Skammtíma") |> 
    filter(date == min(date)) |> 
    pull(diff)


# 1 mánaða spá
fc_1m_diff <- parse_number(fc_ls$verdbolguspa_valuebox$spa_1m) / 100
```

```{r, fc_valuebox_next_month}
#| content: valuebox
#| title: "Verðbólguspá næsta mánaðar"
list(
    icon = case_when(
        fc_diff > 0 ~ "arrow-up",
        fc_diff == 0 ~ "dash",
        TRUE ~ "arrow-down"
        ),
    color = 
        case_when(
        fc_diff > 0 ~ valuebox_litir[2],
        fc_diff == 0 ~ valuebox_litir[3],
        TRUE ~ valuebox_litir[1]
        ),
    value = fc_ls$verdbolguspa_valuebox$spa_12m
)
```

```{r, fc_valuebox}
#| content: valuebox
#| title: "Verðbólguspá - Hækkun milli mánaða"
list(
    icon = case_when(
        fc_1m_diff > 0 ~ "arrow-up",
        fc_1m_diff == 0 ~ "dash",
        TRUE ~ "arrow-down"
        ),
    color = 
        case_when(
        fc_1m_diff > 0 ~ valuebox_litir[2],
        fc_1m_diff == 0 ~ valuebox_litir[3],
        TRUE ~ valuebox_litir[1]
        ),
    value = fc_ls$verdbolguspa_valuebox$spa_1m
)
```

## Row

```{r verðbólguspá}
fc_litir <- c(
    vr_litir[c(8, 7, 3)],
    # Landsbankinn
    "#00436c",
    # Íslandsbanki
    "#dc1d37" 
)

name_levels <- fc_ls$verdbolguspa |>
  distinct(name) |>
  pull(name) |>
  unique()

# build a named color vector for everything:
# fc_litir can be named or unnamed; we force names to match `name_levels`
cols_all <- c(setNames(fc_litir, name_levels),
              "Seðlabankinn" = "#004864")

breaks_all <- c(name_levels, "Seðlabankinn")

# p18 <- fc_ls$verdbolguspa |>
#   ggplot(aes(date, value)) +
#   geom_line(aes(color = name)) +
#   geom_point(aes(y = `Seðlabankinn`, color = "Seðlabankinn"),
#              na.rm = TRUE) +
#   labs(
#     x = NULL, y = NULL,
#     title = "Verðbólguspá",
#     color = "Uppruni"
#   ) +
#   scale_y_continuous(labels = percent) +
#   theme_minimal() +
#   scale_color_manual(values = cols_all,
#                      breaks = breaks_all,
#                      drop = FALSE)


# vr_layout(p18)

p18 <- fc_ls$verdbolguspa |>
  mutate(
    value_label = scales::percent(value, accuracy = 0.01),
    sedlabanki_label = ifelse(is.na(`Seðlabankinn`), NA,
                              scales::percent(`Seðlabankinn`, accuracy = 0.01))
  ) |>
  ggplot(aes(date, value)) +
  geom_line(aes(color = name,
                group = name,                      # <-- keep paths intact
                text  = paste0(name, "<br>", date, "<br>", value_label))) +
  geom_point(
    aes(y = `Seðlabankinn`, color = "Seðlabankinn",
        text = paste0("Seðlabankinn<br>", date, "<br>", sedlabanki_label)),
    na.rm = TRUE
  ) +
  labs(x = NULL, y = NULL, title = "Verðbólguspá", color = "Uppruni") +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  scale_color_manual(values = cols_all, breaks = breaks_all, drop = FALSE)

vr_layout <- function(plot) {
  plotly::ggplotly(plot, tooltip = "text") |>
    plotly::layout(
      legend = list(title = list(text = ""), orientation = "h",
                    y = -0.2, x = 0.5, xanchor = "center")
    )
}

vr_layout(p18)
```